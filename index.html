<!DOCTYPE HTML>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">

<title>Recorder测试</title>

</head>

<body>
<!--加载核心库，其他类型支持库在下面根据用户点击选择加载-->
<script src="https://cdn.bootcss.com/jquery/1.9.1/jquery.min.js"></script>

<script src="src/recorder-core.js"></script>

<script src="src/engine/mp3.js"></script>
<script src="src/engine/mp3-engine.js"></script>


<div>
	<div class="pd">
		GitHub：<a href="https://github.com/xiangyuecn/Recorder">https://github.com/xiangyuecn/Recorder</a>
	</div>

	<div class="pd">
		<button onclick="recopen()">打开录音</button>
		<button onclick="recclose()">关闭录音</button>
		<button onclick="recstart()">录制</button>
		<button onclick="recstop()">停止</button>
		
		<button onclick="recpause()" style="margin-left:60px">暂停</button>
		<button onclick="recresume()">继续</button>
	</div>
	
	<hr>
	<audio class="recPlay" style="width:100%"></audio>
	<div class="reclog"></div>
	<div class="recinfo"></div>
</div>
<script type="text/template" class="tp_recinfo">
<hr/>

</script>



<script>
function reclog(s){
	$(".reclog").prepend('<div>['+new Date().toLocaleTimeString()+']'+s+'</div>');
};
$(window).bind("error",function(e){
	reclog('<span style="color:red">【Error】:<pre>'+(e.error?e.error.stack:event.message)+'</pre></span>');
});
</script>



<script>
var rec;
function recopen(){
	var type='mp3';
	var bit=16;
	var sample=16000;
	rec=Recorder({
		type:type
		,bitRate:bit
		,sampleRate:sample
		,onProcess:function(buffers,level,time,sampleRate){
		
		}
	});
	rec.open(function(){
		// recstart();
		rec.start();
	},function(e,isUserNotAllow){
	});
};
// function recclose(){
// 	if(rec){
// 		rec.close(function(){
// 			reclog("已关闭");
// 		});
// 	}
// };
// function recstart(){
// 	if(rec){
// 		rec.start();
// 		// reclog("录制中...");
// 	};
// };
// function recpause(){
// 	if(rec){
// 		rec.pause();
// 		reclog("已暂停");
// 	};
// };
// function recresume(){
// 	if(rec){
// 		rec.resume();
// 		reclog("继续录音中...");
// 	};
// };
RandomKey.idx=0;
function RandomKey(){
	return "randomkey"+(RandomKey.idx++);
};
var recblob={};
function recstop(){
	if(rec){

		var t1=Date.now();
		rec.stop(function(blob,time){
			var id=RandomKey(16);
			recblob[id]={blob:blob,set:$.extend({},rec.set),time:time};
			reclog("已录制:"+intp(rec.set.bitRate,3)+"kbps "+intp(rec.set.sampleRate,5)+"hz 花"+intp(Date.now()-t1,4)+"ms编码"+intp(blob.size,6)+"b ["+rec.set.type+"]"+intp(time,6)+'ms <button onclick="recdown(\''+id+'\')">下载</button> <button onclick="recplay(\''+id+'\')">播放</button> <span class="p'+id+'"></span> <span class="d'+id+'"></span>');
		},function(s){

		});
	};
};
var intp=function(s,len){
	s=""+s;
	if(s.length>=len)return s;
	return ("_______"+s).substr(-len);
};
function recplay(key){
	var o=recblob[key];
	if(o){
		var audio=$(".recPlay")[0];
		audio.controls=true;
		if(!(audio.ended || audio.paused)){
			audio.pause();
		};
		o.play=(o.play||0)+1;
		var logmsg=function(msg){
			$(".p"+key).html('<span style="color:green">'+o.play+'</span> '+new Date().toLocaleTimeString()+" "+msg);
		};
		logmsg("");
		
		var end=function(blob){
			audio.src=URL.createObjectURL(blob);
			audio.play();
		};
		var wav=Recorder[o.set.type+"2wav"];
		if(wav){
			logmsg("正在转码成wav...");
			wav(o.blob,function(blob){
				end(blob);
				logmsg("已转码成wav播放");
			},function(msg){
				logmsg("转码成wav失败："+msg);
			});
		}else{
			end(o.blob);
		};
	};
};



//下面的方法都是可选的，不是必要的

function recstop2(){
	if(!rec||!rec.buffer){
		reclog("需先录个音");
		return;
	};
	
	var type=$("[name=type]:checked").val();
	var sample=+$(".sample").val();
	var bits=/(\d+)\s+to\s+(\d+)\s+step\s+(\d+)\s*/i.exec($(".bits").val());
	if(!bits){
		reclog("码率列表有误，需要? to ? step ?结构");
		return;
	};
	reclog("开始批量编码，请勿进行其他操作~");
	
	rec.set.type=type;
	rec.set.sampleRate=sample;
	
	var list=[];
	for(var i=+bits[1];i<+bits[2]+1;i+=+bits[3]){
		list.push(i);
	};
	if(rec.set.type=="wav"){
		list=[8,16];
	};
	
	
	var i=-1;
	var bak=rec.set.bitRate;
	var run=function(){
		i++;
		if(i>=list.length){
			rec.set.bitRate=bak;
			reclog("批量编码完成");
			return;
		};
		rec.set.bitRate=list[i];
		rec.state=1;
		recstop(run);
	};
	run();
};

function recdown(key){
	var o=recblob[key];
	if(o){
		var cls=RandomKey(16);
		var name="rec-"+o.time+"ms-"+o.set.bitRate+"kbps-"+o.set.sampleRate+"hz."+o.set.type;
		
		o.down=(o.down||0)+1;
		$(".d"+key).html('<span style="color:red">'+o.down+'</span> <span class="'+cls+'"> 没弹下载？试一下链接或复制文本<button onclick="recdown64(\''+key+'\',\''+cls+'\')">生成Base64文本</button></span>');
		
		var downA=document.createElement("A");
		downA.innerHTML="下载 "+name;
		downA.href=URL.createObjectURL(o.blob);
		downA.download=name;
		$("."+cls).prepend(downA);
		downA.click();
	};
};
function recdown64(key, cls){
	var o=recblob[key];
	
	var reader = new FileReader();
	reader.onloadend = function() {
		var id=RandomKey(16);
		$("."+cls).append('<textarea class="'+id+'"></textarea>');
		$("."+id).val(reader.result);
	};
	reader.readAsDataURL(o.blob);
};

</script>


</body>
</html>